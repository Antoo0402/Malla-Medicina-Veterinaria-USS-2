<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malla Completa Veterinaria USS</title>
  <style>
    /* [Mantener todos los estilos CSS anteriores igual] */
    /* ... (todo el CSS previo se mantiene exactamente igual) ... */
  </style>
</head>
<body>
  <h1>Malla Curricular de Medicina Veterinaria USS</h1>
  <div class="malla-container" id="malla">
    <!-- Los semestres se cargarán aquí -->
  </div>

  <script>
    // [Mantener los datos de mallaCompleta exactamente igual que antes]
    // ... (todo el objeto mallaCompleta se mantiene igual) ...

    // Estado de la aplicación
    const state = {
      aprobadas: JSON.parse(localStorage.getItem('materiasAprobadas')) || {},
      totalCursos: mallaCompleta.reduce((total, sem) => total + sem.cursos.length, 0)
    };

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
      renderMalla();
    });

    // Renderizar toda la malla
    function renderMalla() {
      const container = document.getElementById('malla');
      if (!container) return;
      
      container.innerHTML = '';
      const cursosAprobados = new Set(Object.keys(state.aprobadas));
      
      mallaCompleta.forEach(semestre => {
        const semestreElement = document.createElement('div');
        semestreElement.className = 'semestre';
        
        const titulo = document.createElement('h2');
        titulo.textContent = semestre.semestre;
        semestreElement.appendChild(titulo);
        
        semestre.cursos.forEach(curso => {
          const cursoElement = document.createElement('div');
          cursoElement.className = 'curso';
          cursoElement.textContent = curso.nombre;
          cursoElement.dataset.nombre = curso.nombre;
          
          if (curso.abre && curso.abre.length > 0) {
            const abreElement = document.createElement('div');
            abreElement.className = 'abre';
            abreElement.textContent = `Abre: ${curso.abre.join(', ')}`;
            cursoElement.appendChild(abreElement);
          }
          
          if (state.aprobadas[curso.nombre]) {
            cursoElement.classList.add('aprobado');
          } else if (!estaDisponible(curso, cursosAprobados)) {
            cursoElement.classList.add('bloqueado');
          }
          
          cursoElement.addEventListener('click', function() {
            if (!this.classList.contains('bloqueado')) {
              toggleAprobado(this);
            }
          });
          
          semestreElement.appendChild(cursoElement);
        });
        
        container.appendChild(semestreElement);
      });
    }

    // Función CORREGIDA para verificar disponibilidad
    function estaDisponible(curso, cursosAprobados) {
      // Caso especial para Memoria de título
      if (curso.requiereTodo) {
        const totalRequerido = state.totalCursos - 4;
        return cursosAprobados.size >= totalRequerido;
      }

      // Caso especial para Inmunología - REQUISITOS DUROS
      if (curso.nombre === "Immunología") {
        const requisitosInmunologia = ["Histología Veterinaria", "Bienestar animal"];
        const todosRequisitosCumplidos = requisitosInmunologia.every(req => cursosAprobados.has(req));
        
        // Verificar además que esté en el semestre correcto (3ro)
        const semestreActual = mallaCompleta.find(sem => sem.cursos.some(c => c.nombre === curso.nombre));
        const esTercerSemestre = semestreActual.semestre === "3er Semestre";
        
        return todosRequisitosCumplidos && esTercerSemestre;
      }

      // Cursos del primer semestre siempre disponibles
      const esPrimerSemestre = mallaCompleta[0].cursos.some(c => c.nombre === curso.nombre);
      if (esPrimerSemestre) return true;

      // Para otros cursos: verificar que todos los que lo abren estén aprobados
      const cursosQueAbrenEste = [];
      mallaCompleta.forEach(sem => {
        sem.cursos.forEach(c => {
          if (c.abre && c.abre.includes(curso.nombre)) {
            cursosQueAbrenEste.push(c.nombre);
          }
        });
      });

      // Si no tiene cursos que lo abran, está disponible
      if (cursosQueAbrenEste.length === 0) return true;

      // Verificar que TODOS los cursos que lo abren estén aprobados
      return cursosQueAbrenEste.every(req => cursosAprobados.has(req));
    }

    // Alternar estado de aprobado
    function toggleAprobado(elemento) {
      const nombre = elemento.dataset.nombre;
      state.aprobadas[nombre] = !state.aprobadas[nombre];
      localStorage.setItem('materiasAprobadas', JSON.stringify(state.aprobadas));
      renderMalla();
    }
  </script>
</body>
</html>
