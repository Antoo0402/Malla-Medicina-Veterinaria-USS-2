// Función para alternar estado de aprobado con mejor manejo de dependencias
function toggleAprobado(elemento) {
    const nombre = elemento.dataset.nombre;
    
    // Si el curso está bloqueado, no hacer nada
    if (elemento.classList.contains('bloqueado')) return;
    
    // Alternar estado
    state.aprobadas[nombre] = !state.aprobadas[nombre];
    localStorage.setItem('materiasAprobadas', JSON.stringify(state.aprobadas));
    
    // Animación de cambio de estado
    elemento.style.transform = 'scale(0.95)';
    setTimeout(() => {
        elemento.style.transform = '';
        elemento.classList.toggle('aprobado', state.aprobadas[nombre]);
    }, 150);
    
    // Buscar todos los ramos que podrían desbloquearse con este cambio
    const ramosADesbloquear = new Set();
    
    // Verificar en toda la malla qué ramos dependen del que acabamos de cambiar
    mallaCompleta.forEach(semestre => {
        semestre.cursos.forEach(curso => {
            // Verificar si este curso tiene como requisito el ramo que acabamos de cambiar
            const tieneRequisitoDirecto = curso.abre && curso.abre.includes(nombre);
            const tieneRequisitoEspecial = requisitosEspeciales[curso.nombre] && 
                                          requisitosEspeciales[curso.nombre].includes(nombre);
            
            if (tieneRequisitoDirecto || tieneRequisitoEspecial) {
                ramosADesbloquear.add(curso.nombre);
            }
        });
    });
    
    // Actualizar visualmente los ramos afectados
    ramosADesbloquear.forEach(ramo => {
        setTimeout(() => {
            actualizarEstadoCurso(ramo);
            
            // Efecto visual para ramos recién desbloqueados
            const elementos = document.querySelectorAll(`.curso[data-nombre="${ramo}"]`);
            elementos.forEach(el => {
                if (!el.classList.contains('bloqueado') && !el.classList.contains('aprobado')) {
                    el.style.animation = 'pulse 0.5s';
                    setTimeout(() => el.style.animation = '', 500);
                }
            });
        }, 200);
    });
}

// Agregar esta animación al estilo CSS (añadir al <style> existente)
/*
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
*/

// Función mejorada para actualizar el estado visual de un curso
function actualizarEstadoCurso(nombreCurso) {
    const elementos = document.querySelectorAll(`.curso[data-nombre="${nombreCurso}"]`);
    if (!elementos || elementos.length === 0) return;
    
    // Encontrar el curso en la malla
    let curso = null;
    let semestreIndex = -1;
    
    mallaCompleta.forEach((sem, index) => {
        sem.cursos.forEach(c => {
            if (c.nombre === nombreCurso) {
                curso = c;
                semestreIndex = index;
            }
        });
    });
    
    if (!curso) return;
    
    // Actualizar todos los elementos con el mismo nombre
    elementos.forEach(elemento => {
        elemento.classList.remove('aprobado', 'bloqueado');
        
        if (state.aprobadas[nombreCurso]) {
            elemento.classList.add('aprobado');
        } else if (!estaDisponible(curso, semestreIndex)) {
            elemento.classList.add('bloqueado');
        }
    });
}
